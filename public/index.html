<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiberNet SpeedTest</title>
    <style>
        :root {
            --primary: #00d2ff;
            --bg: #1a1a1a;
            --panel: #2d2d2d;
            --text: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 {
            margin-bottom: 30px;
            letter-spacing: 1px;
        }

        h1 span {
            color: var(--primary);
        }

        .meter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            max-width: 800px;
            width: 100%;
        }

        .meter-box {
            background: var(--panel);
            padding: 25px;
            border-radius: 12px;
            width: 160px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .meter-box:hover {
            transform: translateY(-2px);
        }

        .meter-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
            min-height: 40px;
        }

        .meter-label {
            font-size: 14px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .meter-unit {
            font-size: 12px;
            color: #666;
        }

        #startStopBtn {
            background-color: var(--primary);
            color: #000;
            border: none;
            padding: 18px 50px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
            text-transform: uppercase;
        }

        #startStopBtn:hover {
            background-color: #33ddff;
            box-shadow: 0 0 25px rgba(0, 210, 255, 0.5);
            transform: scale(1.05);
        }

        #startStopBtn.running {
            background-color: #ff4444;
            color: white;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }

        .status-bar {
            margin-top: 30px;
            color: #888;
            font-size: 14px;
        }

        #ip {
            color: var(--text);
            font-weight: bold;
        }

        /* Loading indicator */
        .lds-dual-ring {
            display: inline-block;
            width: 80px;
            height: 80px;
            display: none;
        }

        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 64px;
            height: 64px;
            margin: 8px;
            border-radius: 50%;
            border: 6px solid var(--primary);
            border-color: var(--primary) transparent var(--primary) transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }

        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <h1>FiberNet <span>SpeedTest</span></h1>

    <div class="meter-container">
        <div class="meter-box">
            <div class="meter-label">Download</div>
            <div id="dlText" class="meter-value">--</div>
            <div class="meter-unit">Mbps</div>
        </div>
        <div class="meter-box">
            <div class="meter-label">Upload</div>
            <div id="ulText" class="meter-value">--</div>
            <div class="meter-unit">Mbps</div>
        </div>
        <div class="meter-box">
            <div class="meter-label">Ping</div>
            <div id="pingText" class="meter-value">--</div>
            <div class="meter-unit">ms</div>
        </div>
        <div class="meter-box">
            <div class="meter-label">Jitter</div>
            <div id="jitText" class="meter-value">--</div>
            <div class="meter-unit">ms</div>
        </div>
    </div>

    <div id="loading" class="lds-dual-ring"></div>

    <button id="startStopBtn" onclick="startStop()">Iniciar Teste</button>

    <div class="status-bar">
        IP Detectado: <span id="ip">Carregando...</span>
    </div>

    <!-- Scripts do LibreSpeed -->
    <script type="text/javascript" src="speedtest.js"></script>
    <script type="text/javascript">
        // Configuração apontando para o SEU backend (routes/speedtest.js)
        var SPEEDTEST_SERVERS = [
            {
                name: "FiberNet Local Server",
                server: "/api/speedtest/", // Base URL da rota com barra final
                dlURL: "garbage",          // Endpoint relativo
                ulURL: "empty",
                pingURL: "empty",
                getIpURL: "getIP"
            }
        ];

        var s = null; // Instância do Speedtest

        function initSpeedtest() {
            if (typeof Speedtest === 'undefined') {
                console.error("Biblioteca speedtest.js não carregada. Verifique se o arquivo está na pasta public.");
                document.getElementById("ip").textContent = "Erro: Biblioteca ausente";
                return;
            }

            s = new Speedtest();
            s.setParameter("telemetry_level", "basic");

            // Atualização da UI durante o teste
            s.onupdate = function (data) {
                updateUI(data);
            };

            // Fim do teste
            s.onend = function (aborted) {
                document.getElementById("startStopBtn").textContent = "Iniciar Teste";
                document.getElementById("startStopBtn").className = "";
                document.getElementById("loading").style.display = "none";
            };

            // Carrega IP inicial
            // O LibreSpeed faz isso automaticamente ao selecionar servidor, 
            // mas podemos forçar uma chamada simples se quisermos mostrar antes.
        }

        function updateUI(data) {
            var dl = data.dlStatus;
            var ul = data.ulStatus;
            var ping = data.pingStatus;
            var jit = data.jitterStatus;
            var ip = data.clientIp;

            document.getElementById("dlText").textContent = (dl === 0 || dl === "") ? "--" : dl;
            document.getElementById("ulText").textContent = (ul === 0 || ul === "") ? "--" : ul;
            document.getElementById("pingText").textContent = (ping === 0 || ping === "") ? "--" : ping;
            document.getElementById("jitText").textContent = (jit === 0 || jit === "") ? "--" : jit;
            document.getElementById("ip").textContent = ip;
        }

        function startStop() {
            if (!s) initSpeedtest();
            if (!s) return;

            if (s.getState() === 3) {
                // Está rodando, então para
                s.abort();
                document.getElementById("startStopBtn").textContent = "Iniciar Teste";
                document.getElementById("startStopBtn").className = "";
                document.getElementById("loading").style.display = "none";
            } else {
                // Inicia
                document.getElementById("startStopBtn").textContent = "Cancelar";
                document.getElementById("startStopBtn").className = "running";
                document.getElementById("loading").style.display = "inline-block";

                // Reseta valores visuais
                updateUI({ dlStatus: "--", ulStatus: "--", pingStatus: "--", jitterStatus: "--", clientIp: "Detectando..." });

                s.addTestPoints(SPEEDTEST_SERVERS);
                s.selectServer(SPEEDTEST_SERVERS[0]);
                s.start();
            }
        }

        // Tenta inicializar ao carregar a página
        window.onload = initSpeedtest;
    </script>
</body>

</html>